---
layout: post
title: "docker container"
tags: [docker]
comments: true
date: 2020-06-25
---

## 컨테이너
- 컨테이너란 어플리케이션의 격리된 환경을 지원하는 일종의 가상화 기술이다.
- 기존의 가상화 방식은 주로 호스트 OS위에 게스트 OS 전체를 가상화하는 방식을 사용했기 때문에 굉장히 무겁고 느렸다.
- 도커 컨테이너는 OS자체를 가상화하지 않고 호스트 OS상에 논리적인 구획(컨테이너)을 만들고 프로세스를 격리 시키는 방식이기 때문에 가볍고 빠르게 동작한다.
- 하나의 OS위에 여러 어플리케이션을 독립적으로 실행할 수 있으며 각 어플리케이션들은 자신이 필요한 리소스들을 독립적으로 가질 수 있다.
![No image](/assets/posts/20200625/container-vm.png)


## 컨테이너의 장점
- 서비스의 배포 단위로 컨테이너 이미지를 만들어 사용할 수 있다.
- immutable하게 배포/롤백을 쉽게할 수 있으며 CD, CI에 적합하다.
- 리소스 관리가 효율적이며 MSA에 적합하다.


## 컨테이너 기술 요소
1. Linux Namespace
- Linux Namespace는 프로세스에게 격리된 OS view를 제공하는 커널 기술이다.
- 프로세스 생성 시점에 어떤 네임스페이스를 사용할지 선택할 수 있고, 프로세스는 선택한 네임스페이스 별로 격리된다.
- Namespace를 통해 격리된 프로세스들은 서로 다른 리소스를 사용할 수 있다.

2. cgroup (Control Group)
- cgroup은 어플리케이션에게 하드웨어 리소스(CPU, memory disk, network)를 그룹으로 묶어서 할당하는 기술이다.
- cgroup으로 묶인 프로세스들은 리소스 별로 정해진 량만 사용하게 설정할 수 있다.
- cgroup 노드는 하위에 서브노드를 가질 수 있으며 Leaf-Node는 프로세스가 된다.
- ex) CPU 20%, memory 2G : cgroup1
- ex) CPU 30%, memory 4G : cgroup2

3. cgroup 리소스 할당 방식
- Static Binding : 어떤 cgroup이 특정 리소스만 사용하도록 할 수 있다.
- Priority기반 : 어떤 cgroup에게 특정 리소스 사용의 우선순위를 부여할 수 있다.
- Limit : 어떤 cgroup 에게 시간당 정해진 리소스만 사용하도록 할 수 있다.

4. unionfs (Union File System)
- unionfs는 서로 다른 파일 시스템이나 디렉토리를 합쳐서 하나의 논리적인 파일 시스템으로 컨테이너에게 제공한다.
- 도커 컨테이너가 Namespace와 cgroup에 의해 격리될 때, 컨테이너가 사용할 파일시스템도 격리되어야 한다.
- unionfs를 사용하면 여러 컨테이너가 하나의 이미지를 사용할 경우, 각각의 컨테이너는 자신이 overwrite할 영역만 유지할 수 있다.

## Docker
- 도커는 컨테이너를 이미지 파일로 빌드하고 배포하여 어디서나 실행할 수 있도록 해주는 오픈소스이다.
- 도커는 클라이언트와 서버로 구성되어 있다.
- 모든 명령은 클라이언트 REST로 서버에 요청되어 서버에서 수행한다.
- 도커 서버는 자신만의 도커 이미지 저장소를 가지고 있어서 리모트의 레지스트리와 도커 이미지를 주고 받는다.
- 동작방식
    1. 클라이언트에서 도커 이미지를 빌드하기위해 Dockerfile을 작성한다.
    2. 클라이언트에서는 Dockerfile과 함께 도커빌드 요청을 도커 서버로 보낸다.
    3. 도커 서버에서는 도커 이미지를 빌드하여 로컬 저장소에 저장한다.
    4. 도커 push 명령을 받으면 도커 서버는 로컬의 도커 이미지를 도커 레지스트리에 올린다.
    5. 도커 run 명령을 배포할 도커 서버에 전송한다.
    6. 도커 run 명령을 받은 도커 서버는 도커 레지스트리의 이미지를 로컬 저장소로 다운받는다.
    7. 도커 이미지를 이용하여 컨테이너를 시작한다.

![No image](/assets/posts/20200625/docker.png)