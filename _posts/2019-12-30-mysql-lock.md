---
layout: post
title: "MySQL Lock"
tags: [mysql]
comments: true
date: 2019-12-30
---

## InnoDB 스토리지 엔진 잠금 종류
1. Record Lock
- 레코드 자체만을 잠그는 것을 레코드락이라고 한다. InnoDB스토리지 엔진은 다른 DBMS와는 다르게 레코드 자체가 아니라 인덱스의 레코드를 잠근다. 만약 인덱스가 하나도 없는 테이블이라고 하더라도 내부적으로 자동 생성된 클러스터 인덱스를 이용해 잠금을 설정한다. 프라이머리키 또는 유니크 인덱스에 의한 변경작업은 Gap에 대해서는 잠그지 않고 레코드 자체에 대해서만 락을 건다. 보조 인덱스를 이용한 변경 작업일 경우에는 넥스트 키락을 사용한다.

2. Gap Lock
- 갭 락은 레코드 자체가 아니라 레코드와 바로 인접한 레코드 사이의 간격만을 잠그는 것을 의미한다. 레코드와 레코드 사이으ㅔ 새로운 레코드가 INSERT되는 현상을 방지하는 것이다. 갭락은 개념일 뿐이지 자체적으로 사용되지 않고 넥스트키락의 일부로 사용된다.

3. Next-Key Lock
- 레코드락과 갭락을 합쳐놓은 형태의 잠금을 말한다. InnoDB에서 보조인덱스를 사용한 변경작업은 넥스트키락을 사용한다. PHANTOM READ 를 방지하기 위한 Lock이다.

## MySQL 트랜잭션 격리수준
1. READ UNCOMMITTED
- 가장 낮은 격리 수준으로, 각 트랜잭션에서의 변경 내용이 커밋이나 롤백 여부에 상관없이 다른 트랜잭션에게 보여진다.
- 즉, A 트랜잭션에서 변경한 내용을 커밋하기도 전에 다른 트랜잭션 B에서 변경된 내용을 읽어갈 수 있다.

2. READ COMMITTED
- 한 트랜잭션에서 변경한 내용을 커밋했을 때만 다른 트랜잭션이 읽을 수 있다.
- 변경 전의 내용을 Undo 영역에 기록해놓고 데이터를 변경한다. 그리고 다른 트랜잭션에서 해당 레코드를 읽으려고 할 때 Undo영역에 백업해 놓은 데이터를 읽어가도록 한다.
- 오라클 DBMS에서 기본적으로 사용하는 격리 수준이다.

3. REPEATABLE READ
- READ COMMITTED와 비슷하게 어떤 트랜잭션에서 변경한 내용을 커밋했을 때만 다른 트랜잭션에서 읽어갈 수 있다.
- Undo 영역에 기록하는 것도 READ COMMITTED 와 동일한데 차이점은 언두 영역에 백업된 레코드의 여러 버전 가운데 몇번째 이전 버전까지 찾아 들어가야 하는지에 있다.
- REPEATABLE READ에서는 각 트랜잭션 별로 자동으로 증가하는 트랜잭션 고유번호를 언두 영역에 함께 저장하고, 현재 자신의 트랜잭션 번호보다 이전에 생성된 것만 보게된다. (MVCC - Multi Version Concurrency Control)
- B 트랜잭션이 먼저 시작해서 SELECT를 한번 하고, A 트랜잭션이 중간에 데이터를 변경하고 커밋까지 한 후에 B 트랜잭션이 다시 SELECT를 수행하는 상황이라 가정하자.
- READ COMMITTED에서는 B트랜잭션에서 최초 조회 -> A트랜잭션에서 데이터를 변경후 커밋 -> B 트랜잭션에서 다시 조회(=변경한 내용을 가지고 오게 된다.) -> Non Repeatable Read 문제
- REPEATABLE READ에서는 B트랜잭션에서 최초 조회 -> A트랜잭션에서 데이터를 변경후 커밋 -> B 트랜잭션에서 다시 조회(=B트랜잭션이 먼저 시작했으므로 Undo영역에 기록된 버전 중에서 자신보다 이전 버전만 보게 됨. 즉 A가 나중에 시작했기 때문에 A가 변경한 데이터를 보지 못하고 동일한 결과를 리턴받음)
- InnoDB에서 기본적으로 사용하는 격리 수준이다.

4. SERIALIZABLE
- 가장 단순한 격리 수준이지만 가장 엄격한 격리 수준이다. 또한 그만큼 동시 처리 성능도 다른 트랜잭션 격리 수준보다 떨어진다.
- InnoDB에서 SERIALIZABLE 격리수준보다 낮은 격리수준에서는 기본적으로 순수한 SELECT 쿼리에는 아무런 레코드 잠금도 설정하지 않고 실행된다.
- SERIALIZABLE 격리수준에서는 읽기 작업도 공유잠금(읽기잠금)을 획득해야만 하며, 동시에 다른 트랜잭션은 그러한 레코드를 변경하지 못하게 한다.
> InnoDB 메뉴얼에서 자주 나타나는 "Non-lockingconsistent read(잠금이 필요없는 일관된 읽기)"라는 말이 이를 의미하는 것이다.